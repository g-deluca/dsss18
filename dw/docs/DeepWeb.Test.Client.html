<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>DeepWeb.Test.Client</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library DeepWeb.Test.Client</h1>

<div class="code">
<span class="comment">(*&nbsp;IO&nbsp;monad&nbsp;for&nbsp;Coq.&nbsp;*)</span><br/>

<br/>
<span class="id" title="var">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.extraction.Extraction.html#"><span class="id" title="library">Extraction</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Strings.String.html#"><span class="id" title="library">String</span></a>.<br/>

<br/>
<span class="id" title="var">From</span> <span class="id" title="var">ExtLib</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="library">Monad</span>.<br/>

<br/>
<span class="id" title="var">From</span> <span class="id" title="var">DeepWeb</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="DeepWeb.Lib.Util.html#"><span class="id" title="library">Lib.Util</span></a>.<br/>

<br/>

<br/>
<span class="id" title="keyword">Parameter</span> <a name="file_descr"><span class="id" title="axiom">file_descr</span></a> : <span class="id" title="keyword">Type</span>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="ocaml_unit"><span class="id" title="axiom">ocaml_unit</span></a> : <span class="id" title="keyword">Type</span>.<br/>
<span class="comment">(*&nbsp;Opaque&nbsp;type&nbsp;in&nbsp;case&nbsp;Coq&nbsp;tries&nbsp;to&nbsp;be&nbsp;too&nbsp;smart&nbsp;about&nbsp;<span class="inlinecode"><span class="id" title="var">unit</span></span>.&nbsp;*)</span><br/>

<br/>
<span class="id" title="keyword">Parameter</span> <a name="out_channel"><span class="id" title="axiom">out_channel</span></a> : <span class="id" title="keyword">Type</span>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="error_handle"><span class="id" title="axiom">error_handle</span></a> : <a class="idref" href="DeepWeb.Test.Client.html#out_channel"><span class="id" title="axiom">out_channel</span></a>.<br/>

<br/>
<span class="id" title="keyword">Parameter</span> <a name="IO"><span class="id" title="axiom">IO</span></a>     : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="retIO"><span class="id" title="axiom">retIO</span></a>  : <span class="id" title="keyword">∀</span> <span class="id" title="var">A</span>, <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="bindIO"><span class="id" title="axiom">bindIO</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span>, <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">(</span></a><a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="DeepWeb.Test.Client.html#B"><span class="id" title="variable">B</span></a><a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="DeepWeb.Test.Client.html#B"><span class="id" title="variable">B</span></a>.<br/>

<br/>
<span class="id" title="keyword">Instance</span> <a name="Monad_IO"><span class="id" title="instance">Monad_IO</span></a> : <span class="id" title="class">Monad</span> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> :=<br/>
&nbsp;&nbsp;{ <span class="id" title="method">ret</span> := <a class="idref" href="DeepWeb.Test.Client.html#retIO"><span class="id" title="axiom">retIO</span></a>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="method">bind</span> := <a class="idref" href="DeepWeb.Test.Client.html#bindIO"><span class="id" title="axiom">bindIO</span></a>;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
<span class="id" title="keyword">Parameter</span> <a name="runIO_with_server'"><span class="id" title="axiom">runIO_with_server'</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">A</span>, <a class="idref" href="DeepWeb.Test.Client.html#out_channel"><span class="id" title="axiom">out_channel</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a>.<br/>
<span class="id" title="keyword">Definition</span> <a name="runIO_with_server"><span class="id" title="definition">runIO_with_server</span></a> <span class="id" title="var">A</span> := <a class="idref" href="DeepWeb.Test.Client.html#runIO_with_server'"><span class="id" title="axiom">runIO_with_server'</span></a> <a class="idref" href="DeepWeb.Test.Client.html#A"><span class="id" title="variable">A</span></a> <a class="idref" href="DeepWeb.Test.Client.html#error_handle"><span class="id" title="axiom">error_handle</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="log"><span class="id" title="axiom">log</span></a>    : <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Strings.String.html#string"><span class="id" title="inductive">string</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="close"><span class="id" title="axiom">close</span></a>  : <a class="idref" href="DeepWeb.Test.Client.html#file_descr"><span class="id" title="axiom">file_descr</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="recvb"><span class="id" title="axiom">recvb</span></a>  : <a class="idref" href="DeepWeb.Test.Client.html#file_descr"><span class="id" title="axiom">file_descr</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="DeepWeb.Lib.Util.html#byte"><span class="id" title="definition">byte</span></a>).<br/>
<span class="id" title="keyword">Parameter</span> <a name="sendb"><span class="id" title="axiom">sendb</span></a>  : <a class="idref" href="DeepWeb.Test.Client.html#file_descr"><span class="id" title="axiom">file_descr</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Lib.Util.html#byte"><span class="id" title="definition">byte</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="socket"><span class="id" title="axiom">socket</span></a> : <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> (<a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="DeepWeb.Test.Client.html#file_descr"><span class="id" title="axiom">file_descr</span></a>).<br/>

<br/>
<span class="id" title="var">Arguments</span> <a class="idref" href="DeepWeb.Test.Client.html#runIO_with_server"><span class="id" title="definition">runIO_with_server</span></a> {<span class="id" title="var">A</span>}.<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">IO</span> "'a" ⇒ "unit -&gt; 'a".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">file_descr</span> ⇒ "Unix.file_descr".<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">ocaml_unit</span> ⇒ "unit".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Inlined</span> <span class="id" title="var">Constant</span> <span class="id" title="var">out_channel</span> ⇒ "out_channel".<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">error_handle</span> ⇒ "open_out ""/tmp/client_error""".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">retIO</span> ⇒ "fun a () -&gt; a".<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">bindIO</span> ⇒<br/>
&nbsp;&nbsp;"fun ioa to_iob () -&gt; to_iob (ioa ()) ()".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">runIO_with_server'</span> ⇒ "fun err io -&gt;
  ignore (Unix.system ""make server --quiet"");
  Unix.sleepf 1e-3;
  let a =
    try Some (io ())
    with e -&gt;
      output_string err (Printexc.to_string e);
      output_char err '\n';
      flush err;
      None in
  ignore (Unix.system ""make stop --quiet"");
  a".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">close</span> ⇒ "fun fd () -&gt; Unix.close fd".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">log</span> ⇒ "
  let out = open_out_gen [Open_wronly; Open_append; Open_creat; Open_text]
                0o666 ""/tmp/client_log"" in
  fun cl () -&gt;
    let str =
      Bytes.to_string (
        let s = Bytes.create (List.length cl) in
        let rec copy i = function
        | [] -&gt; s
        | c :: l -&gt; Bytes.set s i c; copy (i+1) l
        in copy 0 cl) in
    output_string out (str ^ ""\n"")".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">recvb</span>  ⇒ "fun sock () -&gt;
  let bs = Bytes.create 1 in
  match Unix.recv sock bs 0 1 [] with
  | exception Unix.Unix_error((Unix.EAGAIN | Unix.EWOULDBLOCK), _, _) -&gt;
     None
  | k -&gt;
     if k = 1 then
       Some (Bytes.get bs 0)
     else
       None".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">sendb</span>  ⇒ "fun sock c () -&gt;
  Unix.send sock (Bytes.make 1 c) 0 1 []".<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">socket</span> ⇒ "fun () -&gt;
  let open Unix in
  let sock = socket PF_INET SOCK_STREAM 0 in
  try
    connect sock (ADDR_INET (inet_addr_loopback, 8000));
    set_nonblock sock;
    Some sock
  with
  | Unix.Unix_error(Unix.ECONNREFUSED, _, _) -&gt;
    close sock;
    None".<br/>

<br/>
<span class="id" title="keyword">Parameter</span> <a name="flip"><span class="id" title="axiom">flip</span></a> : <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>.<br/>
<span class="id" title="keyword">Parameter</span> <a name="rand"><span class="id" title="axiom">rand</span></a> : <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Logic.html#d43e996736952df71ebeeae74d10a287"><span class="id" title="notation">→</span></a> <a class="idref" href="DeepWeb.Test.Client.html#IO"><span class="id" title="axiom">IO</span></a> <a class="idref" href="http://coq.inria.fr/distrib/8.8.0/stdlib//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>.<br/>

<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">flip</span> ⇒ "Random.bool".<br/>
<span class="id" title="keyword">Extract</span> <span class="id" title="var">Constant</span> <span class="id" title="var">rand</span> ⇒ "fun n () -&gt; Random.int n".<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>